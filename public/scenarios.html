<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Scenarios - StructuReality Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        * { font-family: "Poppins", sans-serif; }

        .scenario-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .scenario-card.active-scenario {
            border: 2.5px solid #6366f1;
            background: linear-gradient(135deg, #eef2ff 0%, #f5f3ff 100%);
            box-shadow: 0 6px 24px rgba(99,102,241,0.15);
        }
        .scenario-card.inactive-scenario {
            border: 2px solid #e5e7eb;
            background: #f9fafb;
            opacity: 0.72;
            cursor: pointer;
        }
        .scenario-card.inactive-scenario:hover {
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            border-color: #a5b4fc;
        }
        .scenario-card.coming-soon {
            border: 2px dashed #d1d5db;
            background: #f9fafb;
            opacity: 0.55;
            cursor: not-allowed;
        }

        /* Slot badge ‚Äî shows which button slot (1 or 2) it occupies */
        .slot-badge {
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 99px;
            letter-spacing: 0.05em;
        }
        .slot-1 { background: linear-gradient(135deg,#6366f1,#8b5cf6); color: white; }
        .slot-2 { background: linear-gradient(135deg,#0ea5e9,#38bdf8); color: white; }
        .slot-inactive { background: #e5e7eb; color: #6b7280; }
        .slot-coming   { background: #fef3c7; color: #d97706; }

        .ds-tab { transition: all 0.2s ease; cursor: pointer; white-space: nowrap; }
        .ds-tab.active-tab {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            box-shadow: 0 4px 12px rgba(99,102,241,0.35);
        }
        .ds-tab:not(.active-tab):hover { background: #e0e7ff; color: #4338ca; }

        .stat-card-hover { transition: all 0.3s ease; }
        .stat-card-hover:hover { transform: translateY(-4px); }

        .toggle-btn {
            transition: all 0.2s ease;
            font-size: 0.78rem;
            font-weight: 600;
            padding: 6px 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }
        .toggle-btn.activate {
            background: linear-gradient(135deg,#6366f1,#8b5cf6);
            color: white;
        }
        .toggle-btn.activate:hover { transform: scale(1.04); box-shadow: 0 4px 14px rgba(99,102,241,0.4); }
        .toggle-btn.deactivate {
            background: #fee2e2;
            color: #dc2626;
        }
        .toggle-btn.deactivate:hover { background: #fecaca; }
        .toggle-btn:disabled { background: #d1d5db; color: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; }

        .usage-bar { height: 6px; border-radius: 3px; background: #e5e7eb; overflow: hidden; }
        .usage-fill { height: 100%; border-radius: 3px; transition: width 0.8s ease; }

        .pulse-dot { animation: pulse-anim 2s infinite; }
        @keyframes pulse-anim { 0%,100%{opacity:1} 50%{opacity:0.3} }

        .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; }
        .modal-overlay.open { display:flex; }

        .toast { position:fixed; bottom:2rem; right:2rem; z-index:9999; padding:1rem 1.5rem; border-radius:12px; color:white; font-weight:600; font-size:0.9rem; box-shadow:0 8px 30px rgba(0,0,0,0.2); transform:translateY(100px); opacity:0; transition:all 0.3s ease; }
        .toast.show { transform:translateY(0); opacity:1; }
        .toast.success { background: linear-gradient(135deg,#10b981,#059669); }
        .toast.error   { background: linear-gradient(135deg,#ef4444,#dc2626); }
        .toast.info    { background: linear-gradient(135deg,#6366f1,#8b5cf6); }

        /* Live preview of what the app buttons look like */
        .app-btn-preview {
            border-radius: 12px;
            padding: 10px 18px;
            font-weight: 700;
            font-size: 0.85rem;
            text-align: center;
            color: white;
            background: linear-gradient(135deg,#6366f1,#8b5cf6);
            box-shadow: 0 4px 14px rgba(99,102,241,0.35);
            min-width: 120px;
        }
        .app-btn-preview.slot2 { background: linear-gradient(135deg,#0ea5e9,#38bdf8); box-shadow: 0 4px 14px rgba(14,165,233,0.3); }

        .sparkline { display:flex; align-items:flex-end; gap:3px; height:30px; }
        .sparkline-bar { flex:1; border-radius:2px; min-height:4px; transition:height 0.4s ease; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Sidebar -->
    <aside class="fixed left-0 top-0 h-screen w-64 bg-gradient-to-b from-[#0f1b3f] to-[#2a1b63] text-white shadow-xl z-50">
        <div class="p-6 border-b border-indigo-700">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                    <i class="fas fa-cube text-indigo-700 text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold">StructuReality</h1>
                    <p class="text-xs text-indigo-300">Admin Portal</p>
                </div>
            </div>
        </div>
        <nav class="mt-6 px-4">
            <a href="index.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-indigo-200 hover:bg-indigo-700 mb-2">
                <i class="fas fa-home w-5"></i><span class="font-medium">Dashboard</span>
            </a>
            <a href="users.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-indigo-200 hover:bg-indigo-700 mb-2">
                <i class="fas fa-users w-5"></i><span class="font-medium">Users</span>
            </a>
            <a href="lessons.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-indigo-200 hover:bg-indigo-700 mb-2">
                <i class="fas fa-book w-5"></i><span class="font-medium">Lessons</span>
            </a>
            <a href="quizzes.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-indigo-200 hover:bg-indigo-700 mb-2">
                <i class="fas fa-question-circle w-5"></i><span class="font-medium">Quizzes</span>
            </a>
            <a href="analytics.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-indigo-200 hover:bg-indigo-700 mb-2">
                <i class="fas fa-chart-line w-5"></i><span class="font-medium">Analytics</span>
            </a>
            <a href="scenarios.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-indigo-700 text-white mb-2">
                <i class="fas fa-vr-cardboard w-5"></i><span class="font-medium">AR Scenarios</span>
            </a>
            <a href="instructors.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-indigo-200 hover:bg-indigo-700 mb-2">
                <i class="fas fa-chalkboard-teacher w-5"></i><span class="font-medium">Instructors</span>
            </a>
        </nav>
    </aside>

    <!-- Navbar -->
    <nav class="fixed top-0 left-64 right-0 bg-white shadow-md z-40">
        <div class="px-8 py-4 flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">AR Scenarios</h2>
                <p class="text-sm text-gray-500">Choose which 2 scenarios appear as buttons in the AR app per data structure</p>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="pushConfigToApp()" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-semibold">
                    <i class="fas fa-paper-plane"></i> Push to App
                </button>
                <div class="flex items-center space-x-3 px-4 py-2 hover:bg-gray-100 rounded-lg cursor-pointer">
                    <div class="w-8 h-8 bg-indigo-200 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-indigo-700 text-sm"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800" id="adminUserDisplay">Admin User</p>
                        <p class="text-xs text-gray-500" id="adminEmailDisplay">admin@admin.com</p>
                    </div>
                </div>
                <button onclick="logout()" title="Logout" class="p-2 hover:bg-gray-100 rounded-lg transition">
                    <i class="fas fa-sign-out-alt text-gray-600"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="ml-64 p-8 mt-20">

        <!-- Stats Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 stat-card-hover border-l-4 border-indigo-500">
                <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center mb-4">
                    <i class="fas fa-vr-cardboard text-indigo-600 text-xl"></i>
                </div>
                <h3 class="text-gray-500 text-sm font-medium mb-1">Total Scenarios</h3>
                <p class="text-3xl font-bold text-gray-800">3</p>
                <p class="text-xs text-gray-400 mt-1">Available to activate</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 stat-card-hover border-l-4 border-green-500">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mb-4">
                    <i class="fas fa-toggle-on text-green-600 text-xl"></i>
                </div>
                <h3 class="text-gray-500 text-sm font-medium mb-1">Active (this DS)</h3>
                <p class="text-3xl font-bold text-gray-800" id="activeCountDisplay">-</p>
                <p class="text-xs text-gray-400 mt-1">Max 2 buttons in app</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 stat-card-hover border-l-4 border-yellow-500">
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mb-4">
                    <i class="fas fa-mobile-alt text-yellow-600 text-xl"></i>
                </div>
                <h3 class="text-gray-500 text-sm font-medium mb-1">App Buttons Shown</h3>
                <p class="text-xl font-bold text-gray-800" id="appButtonsDisplay">-</p>
                <p class="text-xs text-gray-400 mt-1">What students see</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 stat-card-hover border-l-4 border-purple-500">
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mb-4">
                    <i class="fas fa-sync text-purple-600 text-xl"></i>
                </div>
                <h3 class="text-gray-500 text-sm font-medium mb-1">Last Config Push</h3>
                <p class="text-lg font-bold text-gray-800" id="lastPush">Never</p>
                <p class="text-xs text-gray-400 mt-1">App config sync</p>
            </div>
        </div>

        <!-- Data Structure Tabs -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6 p-4">
            <p class="text-xs text-gray-500 uppercase font-semibold mb-3 px-1">Select Data Structure</p>
            <div class="flex gap-3 overflow-x-auto pb-1" id="dsTabs"></div>
        </div>

        <!-- App Preview Banner -->
        <div class="bg-gradient-to-r from-indigo-900 to-purple-900 rounded-xl p-5 mb-6 flex items-center gap-6">
            <div class="flex-shrink-0">
                <p class="text-indigo-300 text-xs font-semibold uppercase mb-2">üì± Live App Button Preview</p>
                <p class="text-white text-sm">Students will see these buttons when they open the AR app:</p>
            </div>
            <div class="flex gap-4 ml-4" id="appPreview">
                <!-- Generated by JS -->
            </div>
            <p class="text-indigo-300 text-xs ml-auto max-w-xs text-right">Toggle scenarios ON/OFF below to change which buttons appear in the app.</p>
        </div>

        <!-- Scenario Cards -->
        <div id="scenarioPanel"><!-- Generated by JS --></div>

        <!-- Usage Chart -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 mt-6 p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-800">Usage Analytics ‚Äî <span id="chartDsLabel" class="text-indigo-600">Arrays</span></h3>
                <span class="text-xs text-gray-500">Simulated session counts</span>
            </div>
            <div id="usageChart" class="space-y-4"></div>
        </div>

    </main>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        // =========================================================
        // DATA
        // =========================================================
        const DATA_STRUCTURES = [
            { id: 'Arrays',      label: 'Arrays',      icon: 'fa-layer-group'     },
            { id: 'Queue',       label: 'Queues',       icon: 'fa-stream'          },
            { id: 'Stacks',      label: 'Stacks',       icon: 'fa-layer-group'     },
            { id: 'LinkedLists', label: 'Linked Lists', icon: 'fa-link'            },
            { id: 'Trees',       label: 'Trees',        icon: 'fa-project-diagram' },
            { id: 'Graphs',      label: 'Graphs',       icon: 'fa-sitemap'         },
        ];

        const ALL_SCENARIOS = [
            {
                id: 'ParkingLot',
                name: 'Parking Lot',
                icon: 'üÖøÔ∏è',
                description: 'Cars in parking spots. Students INSERT cars into slots, REMOVE them, and ACCESS any spot by index.',
                sessions: [312, 280, 350, 410, 390, 320, 445],
            },
            {
                id: 'VendingMachine',
                name: 'Vending Machine',
                icon: 'üè™',
                description: 'A 2√ó3 vending grid. Students RESTOCK, DISPENSE, and INSPECT products with Sorted Insert & Binary Search.',
                sessions: [198, 220, 260, 310, 295, 280, 330],
            },
            {
                id: 'Supermarket',
                name: 'Supermarket Shelf',
                icon: 'üõí',
                description: 'Supermarket shelves with labelled slots. Students STOCK items, PULL them off, and CHECK contents.',
                sessions: [90, 110, 140, 175, 160, 155, 200],
            },
        ];

        // =========================================================
        // STATE
        // activeScenarios[dsId] = array of 0, 1, or 2 scenario IDs
        // The ORDER matters ‚Äî index 0 = Button 1, index 1 = Button 2
        // =========================================================
        let activeScenarios = {
            Arrays:      ['ParkingLot', 'VendingMachine'],
            Queue:       ['ParkingLot', 'VendingMachine'],
            Stacks:      ['ParkingLot', 'VendingMachine'],
            LinkedLists: ['ParkingLot', 'VendingMachine'],
            Trees:       ['ParkingLot', 'VendingMachine'],
            Graphs:      ['ParkingLot', 'VendingMachine'],
        };

        let selectedDs = 'Arrays';

        // =========================================================
        // INIT
        // =========================================================
        window.addEventListener('load', () => {
            loadAuthDisplay();
            loadSavedState();
            renderDsTabs();
            renderAll();
        });

        function loadAuthDisplay() {
            const stored = localStorage.getItem('adminUser');
            if (stored && stored !== 'undefined') {
                try {
                    const user = JSON.parse(stored);
                    document.getElementById('adminUserDisplay').textContent = user.name || user.username || 'Admin';
                    document.getElementById('adminEmailDisplay').textContent = user.email || '';
                } catch(e) {}
            }
        }

        function logout() {
            localStorage.removeItem('adminUser');
            window.location.href = 'login.html';
        }

        function loadSavedState() {
            const saved = localStorage.getItem('srActiveScenarios');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Migrate old format (string ‚Üí array)
                    Object.keys(parsed).forEach(ds => {
                        if (typeof parsed[ds] === 'string') {
                            parsed[ds] = [parsed[ds]];
                        }
                    });
                    activeScenarios = { ...activeScenarios, ...parsed };
                } catch(e) {}
            }
            const lastPush = localStorage.getItem('srLastPush');
            if (lastPush) document.getElementById('lastPush').textContent = lastPush;
        }

        function saveState() {
            localStorage.setItem('srActiveScenarios', JSON.stringify(activeScenarios));
        }

        // =========================================================
        // TOGGLE a scenario ON or OFF for the current DS
        // =========================================================
        function toggleScenario(scenarioId) {
            const list = activeScenarios[selectedDs];
            const idx  = list.indexOf(scenarioId);

            if (idx !== -1) {
                // It's currently active ‚Äî deactivate it
                activeScenarios[selectedDs] = list.filter(id => id !== scenarioId);
            } else {
                // It's inactive ‚Äî activate it
                if (list.length >= 2) {
                    showToast('‚ö†Ô∏è Max 2 scenarios active at once. Deactivate one first.', 'error');
                    return;
                }
                activeScenarios[selectedDs] = [...list, scenarioId];
            }

            saveState();
            renderAll();
            showToast(
                idx !== -1
                    ? `üî¥ "${ALL_SCENARIOS.find(s=>s.id===scenarioId)?.name}" removed from app buttons`
                    : `‚úÖ "${ALL_SCENARIOS.find(s=>s.id===scenarioId)?.name}" added to app buttons`,
                idx !== -1 ? 'error' : 'success'
            );
        }

        // =========================================================
        // RENDER ALL
        // =========================================================
        function renderAll() {
            renderScenarioPanel();
            renderAppPreview();
            renderUsageChart();
            renderStats();
        }

        // =========================================================
        // RENDER DS TABS
        // =========================================================
        function renderDsTabs() {
            document.getElementById('dsTabs').innerHTML = DATA_STRUCTURES.map(ds => `
                <button class="ds-tab px-5 py-2.5 rounded-full text-sm font-semibold transition ${ds.id === selectedDs ? 'active-tab' : 'bg-gray-100 text-gray-600'}"
                    onclick="selectDs('${ds.id}')">
                    <i class="fas ${ds.icon} mr-2 text-xs"></i>${ds.label}
                </button>
            `).join('');
        }

        function selectDs(dsId) {
            selectedDs = dsId;
            renderDsTabs();
            renderAll();
        }

        // =========================================================
        // RENDER SCENARIO CARDS
        // =========================================================
        function renderScenarioPanel() {
            const activeList = activeScenarios[selectedDs];
            const dsObj = DATA_STRUCTURES.find(d => d.id === selectedDs);

            let html = `
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Scenarios for <span class="text-indigo-600">${dsObj.label}</span></h3>
                        <p class="text-sm text-gray-500">Toggle scenarios on or off. Active scenarios become buttons in the AR app (max 2).</p>
                    </div>
                    <div class="flex items-center gap-2 bg-indigo-50 px-4 py-2 rounded-lg border border-indigo-100">
                        <span class="pulse-dot w-2.5 h-2.5 rounded-full bg-green-500 inline-block"></span>
                        <span class="text-sm text-indigo-700 font-semibold">${activeList.length}/2 buttons active</span>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
            `;

            ALL_SCENARIOS.forEach(scenario => {
                const slotIdx  = activeList.indexOf(scenario.id); // -1 = inactive, 0 = btn1, 1 = btn2
                const isActive = slotIdx !== -1;
                const canActivate = !isActive && activeList.length < 2;

                // Badge
                let badgeClass, badgeText;
                if (isActive && slotIdx === 0) { badgeClass = 'slot-1'; badgeText = '‚óè Button 1'; }
                else if (isActive && slotIdx === 1) { badgeClass = 'slot-2'; badgeText = '‚óè Button 2'; }
                else { badgeClass = 'slot-inactive'; badgeText = 'Inactive'; }

                // Sparkline
                const maxS = Math.max(...scenario.sessions, 1);
                const sparkBars = scenario.sessions.map(s => {
                    const h = Math.round((s / maxS) * 28);
                    return `<div class="sparkline-bar" style="height:${Math.max(h,4)}px;background:${isActive ? 'linear-gradient(to top,#6366f1,#a78bfa)' : '#d1d5db'}"></div>`;
                }).join('');

                const weekTotal = scenario.sessions.reduce((a,b)=>a+b,0);

                html += `
                    <div class="scenario-card rounded-xl p-6 ${isActive ? 'active-scenario' : 'inactive-scenario'}" 
                         ${!isActive && canActivate ? `onclick="toggleScenario('${scenario.id}')"` : ''}>
                        
                        <div class="flex items-start justify-between mb-4">
                            <div class="text-4xl">${scenario.icon}</div>
                            <span class="slot-badge ${badgeClass}">${badgeText}</span>
                        </div>

                        <h4 class="text-base font-bold text-gray-800 mb-1">${scenario.name}</h4>
                        <p class="text-xs text-gray-500 leading-relaxed mb-4">${scenario.description}</p>

                        <div class="border-t border-gray-100 pt-3 mb-4">
                            <div class="flex justify-between items-center mb-1.5">
                                <span class="text-xs text-gray-400">Weekly sessions</span>
                                <span class="text-xs font-bold text-gray-700">${weekTotal}</span>
                            </div>
                            <div class="sparkline">${sparkBars}</div>
                        </div>

                        <button 
                            class="toggle-btn w-full ${isActive ? 'deactivate' : 'activate'}"
                            onclick="event.stopPropagation(); toggleScenario('${scenario.id}')"
                            ${!isActive && !canActivate ? 'disabled title="Deactivate one scenario first"' : ''}>
                            ${isActive
                                ? `<i class="fas fa-toggle-off mr-1"></i> Deactivate (remove from app)`
                                : canActivate
                                    ? `<i class="fas fa-toggle-on mr-1"></i> Activate (add to app)`
                                    : `<i class="fas fa-lock mr-1"></i> Max 2 active ‚Äî deactivate one first`
                            }
                        </button>

                        ${isActive ? `
                        <p class="text-center text-xs text-indigo-500 font-medium mt-3">
                            <i class="fas fa-mobile-alt mr-1"></i>Showing as Button ${slotIdx + 1} in app
                        </p>` : ''}
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('scenarioPanel').innerHTML = html;
        }

        // =========================================================
        // RENDER APP PREVIEW (what buttons students see)
        // =========================================================
        function renderAppPreview() {
            const activeList = activeScenarios[selectedDs];
            const preview = document.getElementById('appPreview');

            if (activeList.length === 0) {
                preview.innerHTML = `<div class="text-indigo-300 text-sm italic">No buttons active ‚Äî activate at least one scenario below.</div>`;
                return;
            }

            preview.innerHTML = activeList.map((id, i) => {
                const s = ALL_SCENARIOS.find(sc => sc.id === id);
                if (!s) return '';
                return `
                    <div class="flex flex-col items-center gap-2">
                        <div class="app-btn-preview ${i === 1 ? 'slot2' : ''}">
                            ${s.icon} ${s.name}
                        </div>
                        <span class="text-indigo-300 text-xs font-semibold">Button ${i + 1}</span>
                    </div>
                `;
            }).join(`
                <div class="flex items-center text-indigo-400 font-light text-2xl mx-1">|</div>
            `);
        }

        // =========================================================
        // RENDER STATS
        // =========================================================
        function renderStats() {
            const activeList = activeScenarios[selectedDs];
            document.getElementById('activeCountDisplay').textContent = activeList.length;
            document.getElementById('appButtonsDisplay').textContent =
                activeList.length === 0 ? 'No buttons'
                : activeList.map((id,i) => {
                    const s = ALL_SCENARIOS.find(sc=>sc.id===id);
                    return `Btn${i+1}: ${s?.name || id}`;
                }).join(' | ');
        }

        // =========================================================
        // RENDER USAGE CHART
        // =========================================================
        function renderUsageChart() {
            const dsObj = DATA_STRUCTURES.find(d => d.id === selectedDs);
            document.getElementById('chartDsLabel').textContent = dsObj.label;

            const activeList = activeScenarios[selectedDs];
            const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
            const totals = ALL_SCENARIOS.map(s => s.sessions.reduce((a,b)=>a+b,0));
            const grand  = totals.reduce((a,b)=>a+b,0);

            let html = ALL_SCENARIOS.map((s,i) => {
                const isActive = activeList.includes(s.id);
                const pct = grand > 0 ? Math.round((totals[i]/grand)*100) : 0;
                return `
                    <div class="flex items-center gap-4">
                        <div class="w-7 text-xl text-center flex-shrink-0">${s.icon}</div>
                        <div class="w-32 text-sm font-medium text-gray-700 flex-shrink-0">
                            ${s.name}
                            ${isActive ? '<span class="ml-1 text-xs text-indigo-500">‚óè</span>' : ''}
                        </div>
                        <div class="flex-1 usage-bar">
                            <div class="usage-fill" style="width:${pct}%;background:${isActive?'linear-gradient(90deg,#6366f1,#8b5cf6)':'linear-gradient(90deg,#9ca3af,#d1d5db)'}"></div>
                        </div>
                        <div class="w-20 text-right text-sm font-bold text-gray-700">${totals[i]} <span class="text-xs text-gray-400">sessions</span></div>
                        <div class="w-12 text-right text-sm font-semibold ${isActive?'text-indigo-600':'text-gray-400'}">${pct}%</div>
                    </div>
                `;
            }).join('');

            // Daily breakdown for first active scenario
            if (activeList.length > 0) {
                const primaryScenario = ALL_SCENARIOS.find(s => s.id === activeList[0]);
                const maxVal = Math.max(...primaryScenario.sessions, 1);
                html += `
                    <div class="mt-6 border-t border-gray-100 pt-5">
                        <p class="text-xs text-gray-500 uppercase font-semibold mb-3">Button 1 Daily Breakdown (${primaryScenario.name})</p>
                        <div class="flex gap-2">
                            ${days.map((day,i) => {
                                const val = primaryScenario.sessions[i] || 0;
                                const h   = Math.round((val/maxVal)*60);
                                return `
                                    <div class="flex-1 flex flex-col items-center gap-1">
                                        <div class="w-full rounded-md bg-indigo-100 relative" style="height:64px;display:flex;align-items:flex-end">
                                            <div class="w-full rounded-md bg-gradient-to-t from-indigo-500 to-purple-400" style="height:${h}px;min-height:4px;transition:height 0.5s ease"></div>
                                        </div>
                                        <span class="text-xs text-gray-500">${day}</span>
                                        <span class="text-xs font-bold text-gray-700">${val}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            document.getElementById('usageChart').innerHTML = html;
        }

        // =========================================================
        // PUSH CONFIG TO APP
        // =========================================================
        function pushConfigToApp() {
            const now = new Date();
            const formatted = now.toLocaleString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
            localStorage.setItem('srLastPush', formatted);
            document.getElementById('lastPush').textContent = formatted;

            // What gets sent to the Unity app:
            // { "Arrays": ["ParkingLot","VendingMachine"], "Queue": [...], ... }
            console.log('Pushing scenario config to app:', activeScenarios);

            showToast('üöÄ Config pushed to AR app successfully!', 'info');
        }

        // =========================================================
        // TOAST
        // =========================================================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }
    </script>
</body>
</html>
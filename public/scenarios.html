<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StructuReality ¬∑ Scenario Control</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap');

  :root {
    --bg:        #0a0c14;
    --surface:   #11141f;
    --card:      #161a28;
    --border:    #232840;
    --accent:    #5b6af0;
    --accent2:   #9b59f5;
    --green:     #2ecc8a;
    --red:       #e05252;
    --yellow:    #f5c842;
    --text:      #e8eaf6;
    --muted:     #6b7280;
    --radius:    14px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    padding: 0 0 60px;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 20px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .logo {
    display: flex; align-items: center; gap: 12px;
  }
  .logo-mark {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
  }
  .logo-text { font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }
  .logo-sub  { font-size: 11px; color: var(--muted); font-family: 'Space Mono', monospace; margin-top: 1px; }

  .header-right { display: flex; align-items: center; gap: 16px; }
  .server-badge {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 5px 10px;
  }
  .server-badge span { color: var(--green); }

  /* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
  main { max-width: 1100px; margin: 0 auto; padding: 40px 24px; }

  /* ‚îÄ‚îÄ PAGE TITLE ‚îÄ‚îÄ */
  .page-header { margin-bottom: 36px; }
  .page-title  { font-size: 32px; font-weight: 800; letter-spacing: -1px; }
  .page-sub    { color: var(--muted); margin-top: 6px; font-size: 14px; line-height: 1.5; }

  /* ‚îÄ‚îÄ ACTIVE SCENARIOS PREVIEW ‚îÄ‚îÄ */
  .preview-bar {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 24px;
    margin-bottom: 36px;
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
  }
  .preview-label {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    white-space: nowrap;
  }
  .preview-buttons {
    display: flex;
    gap: 10px;
    flex: 1;
    flex-wrap: wrap;
  }
  .preview-btn {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none;
    border-radius: 8px;
    color: white;
    padding: 8px 20px;
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    cursor: default;
    opacity: 1;
    transition: opacity 0.3s;
  }
  .preview-btn.empty {
    background: var(--card);
    border: 1.5px dashed var(--border);
    color: var(--muted);
    font-weight: 400;
  }
  .preview-arrow {
    color: var(--muted);
    font-size: 18px;
    padding: 0 4px;
  }
  .app-screen {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 12px;
    color: var(--muted);
  }

  /* ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ */
  .status-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }
  .status-count {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 20px;
    border: 1px solid var(--border);
  }
  .status-count.ok   { border-color: var(--green); color: var(--green); }
  .status-count.warn { border-color: var(--yellow); color: var(--yellow); }
  .status-count.err  { border-color: var(--red); color: var(--red); }
  .status-hint { font-size: 13px; color: var(--muted); }

  /* ‚îÄ‚îÄ SCENARIO GRID ‚îÄ‚îÄ */
  .scenarios-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
  }

  .scenario-card {
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    transition: border-color 0.25s, transform 0.2s, box-shadow 0.25s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .scenario-card::before {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    background: linear-gradient(135deg, rgba(91,106,240,0.07), rgba(155,89,245,0.07));
    transition: opacity 0.25s;
    pointer-events: none;
  }
  .scenario-card.active {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px var(--accent), 0 8px 32px rgba(91,106,240,0.2);
  }
  .scenario-card.active::before { opacity: 1; }
  .scenario-card:hover { transform: translateY(-2px); }

  .card-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  .card-icon {
    width: 52px; height: 52px;
    border-radius: 12px;
    background: var(--surface);
    display: flex; align-items: center; justify-content: center;
    font-size: 26px;
    border: 1px solid var(--border);
  }
  .scenario-card.active .card-icon {
    background: rgba(91,106,240,0.15);
    border-color: var(--accent);
  }

  .toggle-wrap { display: flex; align-items: center; gap: 8px; }
  .toggle-label { font-size: 11px; color: var(--muted); font-family: 'Space Mono', monospace; }
  .toggle {
    position: relative;
    width: 42px; height: 24px;
    cursor: pointer;
  }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .slider {
    position: absolute;
    inset: 0;
    background: var(--border);
    border-radius: 24px;
    transition: background 0.25s;
  }
  .slider::before {
    content: '';
    position: absolute;
    width: 18px; height: 18px;
    left: 3px; top: 3px;
    background: var(--muted);
    border-radius: 50%;
    transition: transform 0.25s, background 0.25s;
  }
  .toggle input:checked + .slider { background: var(--accent); }
  .toggle input:checked + .slider::before { transform: translateX(18px); background: white; }

  .card-name { font-size: 20px; font-weight: 800; margin-bottom: 4px; letter-spacing: -0.3px; }
  .card-id   {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    background: var(--surface);
    border-radius: 4px;
    padding: 2px 6px;
    display: inline-block;
    margin-bottom: 12px;
    border: 1px solid var(--border);
  }
  .card-desc { font-size: 13px; color: var(--muted); line-height: 1.6; margin-bottom: 16px; }

  .card-ops {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }
  .op-tag {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 4px;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--muted);
  }
  .scenario-card.active .op-tag {
    border-color: rgba(91,106,240,0.4);
    color: var(--accent);
  }

  .card-stats {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .stat-item { text-align: center; }
  .stat-num  { font-size: 20px; font-weight: 800; }
  .stat-lbl  { font-size: 10px; color: var(--muted); font-family: 'Space Mono', monospace; margin-top: 2px; }
  .sparkline { flex: 1; max-width: 100px; height: 30px; margin: 0 16px; }

  .active-badge {
    position: absolute;
    top: 12px;
    right: 58px;
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    background: var(--accent);
    color: white;
    padding: 2px 7px;
    border-radius: 3px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    opacity: 0;
    transition: opacity 0.25s;
  }
  .scenario-card.active .active-badge { opacity: 1; }

  /* ‚îÄ‚îÄ PUSH SECTION ‚îÄ‚îÄ */
  .push-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 24px;
    flex-wrap: wrap;
  }
  .push-info h3  { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
  .push-info p   { font-size: 13px; color: var(--muted); line-height: 1.5; }

  .push-actions { display: flex; gap: 12px; align-items: center; }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: 10px;
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }
  .btn-primary {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: white;
  }
  .btn-primary:hover { opacity: 0.88; transform: translateY(-1px); }
  .btn-primary:active { transform: translateY(0); opacity: 1; }
  .btn-secondary {
    background: var(--card);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

  /* ‚îÄ‚îÄ TOAST NOTIFICATION ‚îÄ‚îÄ */
  .toast {
    position: fixed;
    bottom: 28px;
    right: 28px;
    padding: 14px 20px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 999;
    max-width: 340px;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.success { background: #1a3d2e; border: 1px solid var(--green); color: var(--green); }
  .toast.error   { background: #3d1a1a; border: 1px solid var(--red);   color: var(--red);   }
  .toast.info    { background: #1a2060; border: 1px solid var(--accent); color: #9ba8ff; }

  /* ‚îÄ‚îÄ LOADING OVERLAY ‚îÄ‚îÄ */
  .loading {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(10,12,20,0.7);
    z-index: 200;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }
  .loading.show { display: flex; }
  .spinner {
    width: 40px; height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
  .divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 36px 0;
  }

  /* ‚îÄ‚îÄ LOGS / HISTORY ‚îÄ‚îÄ */
  .logs-section h3 {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 16px;
  }
  .log-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .log-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 13px;
  }
  .log-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .log-dot.success { background: var(--green); }
  .log-dot.info    { background: var(--accent); }
  .log-time { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); margin-left: auto; }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-mark">üìê</div>
    <div>
      <div class="logo-text">StructuReality</div>
      <div class="logo-sub">Admin ¬∑ Scenario Control</div>
    </div>
  </div>
  <div class="header-right">
    <div class="server-badge">API: <span id="apiStatus">connecting‚Ä¶</span></div>
  </div>
</header>

<!-- MAIN -->
<main>
  <div class="page-header">
    <h1 class="page-title">Scenario Manager</h1>
    <p class="page-sub">
      Select which 2 scenarios appear as buttons in the AR app for the <strong>Arrays</strong> data structure.<br>
      Toggle to activate/deactivate, then push the config to the server.
    </p>
  </div>

  <!-- APP PREVIEW -->
  <div class="preview-bar">
    <span class="preview-label">App Preview</span>
    <div class="app-screen">üì± Arrays Screen</div>
    <span class="preview-arrow">‚Üí</span>
    <div class="preview-buttons">
      <div class="preview-btn" id="previewBtn1">‚Äî</div>
      <div class="preview-btn" id="previewBtn2">‚Äî</div>
    </div>
  </div>

  <!-- STATUS -->
  <div class="status-bar">
    <div class="status-count" id="activeCount">0 of 3 active</div>
    <span class="status-hint" id="statusHint">Toggle exactly 2 scenarios to enable push.</span>
  </div>

  <!-- SCENARIO CARDS -->
  <div class="scenarios-grid" id="scenariosGrid">
    <!-- Populated by JS -->
  </div>

  <!-- PUSH SECTION -->
  <div class="push-section">
    <div class="push-info">
      <h3>Push to App</h3>
      <p>Saves the selected scenario config to the server. The AR app reads this on every launch and reset.</p>
    </div>
    <div class="push-actions">
      <button class="btn btn-secondary" onclick="loadConfig()">‚Üª Reload</button>
      <button class="btn btn-primary" id="pushBtn" onclick="pushConfig()" disabled>
        ‚¨Ü Push to App
      </button>
    </div>
  </div>

  <hr class="divider">

  <!-- ACTIVITY LOG -->
  <div class="logs-section">
    <h3>Activity Log</h3>
    <div class="log-list" id="logList">
      <div class="log-item">
        <div class="log-dot info"></div>
        <span>Admin panel loaded ‚Äî fetching server config‚Ä¶</span>
        <span class="log-time" id="initTime"></span>
      </div>
    </div>
  </div>
</main>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- LOADING -->
<div class="loading" id="loading">
  <div class="spinner"></div>
</div>

<script>
// ============================================================
// CONFIG
// ============================================================
const SERVER_URL = 'https://structureality-admin.onrender.com';
const DS_KEY     = 'Arrays';
const MAX_ACTIVE = 2;

// ============================================================
// SCENARIO DEFINITIONS
// ============================================================
const ALL_SCENARIOS = [
  {
    id:          'ParkingLot',
    name:        'Parking Lot',
    icon:        'üÖøÔ∏è',
    desc:        'Cars in numbered parking spots. Students INSERT cars into spots, REMOVE them, and ACCESS a spot directly by index.',
    ops:         ['INSERT', 'REMOVE', 'ACCESS', 'SORTED INSERT', 'BINARY SEARCH'],
    sessions:    [120, 145, 130, 160, 175, 155, 180],
    avgTime:     '4.2 min',
  },
  {
    id:          'VendingMachine',
    name:        'Vending Machine',
    icon:        'üè™',
    desc:        '2√ó3 grid of product slots. Students RESTOCK items, DISPENSE them, and INSPECT a slot by grid address (A0‚ÄìB2).',
    ops:         ['RESTOCK', 'DISPENSE', 'INSPECT', 'SORTED RESTOCK', 'PRICE SEARCH'],
    sessions:    [95, 110, 130, 145, 160, 140, 170],
    avgTime:     '3.8 min',
  },
  {
    id:          'Supermarket',
    name:        'Supermarket Shelf',
    icon:        'üõí',
    desc:        'Linear shelf with 6 grocery slots. Students STOCK items onto the shelf, PULL them off, and CHECK shelf contents by index.',
    ops:         ['STOCK', 'PULL', 'CHECK', 'SORTED STOCK', 'BARCODE SCAN'],
    sessions:    [90, 110, 140, 175, 160, 155, 200],
    avgTime:     '4.0 min',
  },
];

// ============================================================
// STATE
// ============================================================
let activeIds = [];   // ordered list of active scenario IDs (max 2)

// ============================================================
// DOM HELPERS
// ============================================================
function showToast(msg, type = 'info') {
  const t = document.getElementById('toast');
  t.className = `toast ${type}`;
  t.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</span> ${msg}`;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3500);
}

function showLoading(v) {
  document.getElementById('loading').classList.toggle('show', v);
}

function addLog(msg, type = 'info') {
  const list = document.getElementById('logList');
  const now  = new Date().toLocaleTimeString();
  const el   = document.createElement('div');
  el.className = 'log-item';
  el.innerHTML = `<div class="log-dot ${type}"></div><span>${msg}</span><span class="log-time">${now}</span>`;
  list.prepend(el);
  // keep max 20 entries
  while (list.children.length > 20) list.removeChild(list.lastChild);
}

// ============================================================
// RENDER SCENARIOS
// ============================================================
function renderGrid() {
  const grid = document.getElementById('scenariosGrid');
  grid.innerHTML = '';

  ALL_SCENARIOS.forEach(sc => {
    const isActive = activeIds.includes(sc.id);
    const pos      = activeIds.indexOf(sc.id) + 1;   // 1-based position (0 = not active)
    const maxReached = activeIds.length >= MAX_ACTIVE && !isActive;

    const card = document.createElement('div');
    card.className = `scenario-card${isActive ? ' active' : ''}`;
    card.onclick = () => toggleScenario(sc.id);

    const sparkId = `spark_${sc.id}`;

    card.innerHTML = `
      <div class="active-badge">${pos ? `Button ${pos}` : ''}</div>
      <div class="card-top">
        <div class="card-icon">${sc.icon}</div>
        <div class="toggle-wrap">
          <span class="toggle-label">${isActive ? 'ON' : maxReached ? 'MAX' : 'OFF'}</span>
          <label class="toggle" onclick="event.stopPropagation()">
            <input type="checkbox" ${isActive ? 'checked' : ''} ${maxReached ? 'disabled' : ''}
                   onchange="toggleScenario('${sc.id}')">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      <div class="card-name">${sc.name}</div>
      <div class="card-id">${sc.id}</div>
      <div class="card-desc">${sc.desc}</div>
      <div class="card-ops">${sc.ops.map(op => `<span class="op-tag">${op}</span>`).join('')}</div>
      <div class="card-stats">
        <div class="stat-item">
          <div class="stat-num">${sc.sessions.reduce((a,b)=>a+b,0)}</div>
          <div class="stat-lbl">Total Sessions</div>
        </div>
        <svg class="sparkline" id="${sparkId}" viewBox="0 0 100 30" preserveAspectRatio="none"></svg>
        <div class="stat-item">
          <div class="stat-num">${sc.avgTime}</div>
          <div class="stat-lbl">Avg Duration</div>
        </div>
      </div>
    `;

    grid.appendChild(card);
    drawSparkline(sparkId, sc.sessions, isActive);
  });

  updateStatusBar();
  updatePreview();
}

function drawSparkline(id, data, active) {
  const svg = document.getElementById(id);
  if (!svg) return;
  const w = 100, h = 30;
  const min = Math.min(...data), max = Math.max(...data);
  const range = max - min || 1;
  const pts = data.map((v, i) => {
    const x = (i / (data.length - 1)) * w;
    const y = h - ((v - min) / range) * (h - 4) - 2;
    return `${x},${y}`;
  });
  const color = active ? '#5b6af0' : '#3d4155';
  svg.innerHTML = `
    <polyline points="${pts.join(' ')}"
      fill="none" stroke="${color}" stroke-width="1.8"
      stroke-linejoin="round" stroke-linecap="round"/>
  `;
}

function updateStatusBar() {
  const n   = activeIds.length;
  const cnt = document.getElementById('activeCount');
  const hint= document.getElementById('statusHint');
  const btn = document.getElementById('pushBtn');

  cnt.className = `status-count ${n === MAX_ACTIVE ? 'ok' : n > MAX_ACTIVE ? 'err' : 'warn'}`;
  cnt.textContent = `${n} of ${ALL_SCENARIOS.length} active`;

  if (n === MAX_ACTIVE) {
    hint.textContent = '‚úì Exactly 2 active ‚Äî ready to push.';
    hint.style.color = 'var(--green)';
    btn.disabled = false;
  } else {
    hint.textContent = `Select ${MAX_ACTIVE - n} more scenario${MAX_ACTIVE - n !== 1 ? 's' : ''} to enable push.`;
    hint.style.color = 'var(--muted)';
    btn.disabled = true;
  }
}

function updatePreview() {
  const b1 = document.getElementById('previewBtn1');
  const b2 = document.getElementById('previewBtn2');

  const s1 = ALL_SCENARIOS.find(s => s.id === activeIds[0]);
  const s2 = ALL_SCENARIOS.find(s => s.id === activeIds[1]);

  if (s1) { b1.textContent = `${s1.icon} ${s1.name}`; b1.className = 'preview-btn'; }
  else     { b1.textContent = 'Button 1'; b1.className = 'preview-btn empty'; }

  if (s2) { b2.textContent = `${s2.icon} ${s2.name}`; b2.className = 'preview-btn'; }
  else     { b2.textContent = 'Button 2'; b2.className = 'preview-btn empty'; }
}

// ============================================================
// TOGGLE SCENARIO
// ============================================================
function toggleScenario(id) {
  const idx = activeIds.indexOf(id);
  if (idx >= 0) {
    // deactivate
    activeIds.splice(idx, 1);
  } else {
    if (activeIds.length >= MAX_ACTIVE) {
      showToast(`Max ${MAX_ACTIVE} scenarios allowed ‚Äî deactivate one first.`, 'error');
      renderGrid(); // reset checkbox state
      return;
    }
    activeIds.push(id);
  }
  renderGrid();
}

// ============================================================
// LOAD CONFIG FROM SERVER
// ============================================================
async function loadConfig() {
  showLoading(true);
  try {
    const res  = await fetch(`${SERVER_URL}/api/scenarios/config`);
    const data = await res.json();

    if (data.success && data.config && data.config.scenarios) {
      const serverIds = data.config.scenarios[DS_KEY] || [];
      // Only use IDs we know about
      activeIds = serverIds.filter(id => ALL_SCENARIOS.some(s => s.id === id));
    } else {
      activeIds = ['ParkingLot', 'VendingMachine'];
    }

    document.getElementById('apiStatus').textContent = 'connected';
    document.getElementById('apiStatus').style.color  = 'var(--green)';
    addLog(`Loaded config from server ‚Äî active: [${activeIds.join(', ')}]`, 'success');
    showToast('Config loaded from server.', 'success');
  } catch (err) {
    console.warn('Could not reach server:', err);
    activeIds = activeIds.length ? activeIds : ['ParkingLot', 'VendingMachine'];
    document.getElementById('apiStatus').textContent = 'offline';
    document.getElementById('apiStatus').style.color  = 'var(--red)';
    addLog(`Could not reach server ‚Äî using local state.`, 'error');
    showToast('Server unreachable. Working offline.', 'error');
  } finally {
    showLoading(false);
    renderGrid();
  }
}

// ============================================================
// PUSH CONFIG TO SERVER
// ============================================================
async function pushConfig() {
  if (activeIds.length !== MAX_ACTIVE) {
    showToast(`Select exactly ${MAX_ACTIVE} scenarios first.`, 'error');
    return;
  }

  showLoading(true);
  try {
    const payload = {
      scenarios: {
        [DS_KEY]: [...activeIds]
      }
    };

    const res  = await fetch(`${SERVER_URL}/api/scenarios/config`, {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify(payload)
    });
    const data = await res.json();

    if (data.success) {
      addLog(`Pushed config ‚Äî [${activeIds.join(', ')}] ‚Üí live in app.`, 'success');
      showToast(`Config pushed! App will show: ${activeIds.map(id => {
        const s = ALL_SCENARIOS.find(x => x.id === id);
        return s ? `${s.icon} ${s.name}` : id;
      }).join(' + ')}`, 'success');
    } else {
      throw new Error(data.message || 'Server returned failure');
    }
  } catch (err) {
    console.error(err);
    addLog(`Push failed: ${err.message}`, 'error');
    showToast(`Push failed: ${err.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

// ============================================================
// INIT
// ============================================================
document.getElementById('initTime').textContent = new Date().toLocaleTimeString();
loadConfig();
</script>
</body>
</html>
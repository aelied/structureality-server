<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AR Scenarios - StructuReality Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    * { font-family: "Poppins", sans-serif; }
    .card-hover { transition: transform 0.2s, box-shadow 0.2s; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.10); }
    .scenario-card { transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s; }
    .scenario-card.active { border-color: #6366f1; box-shadow: 0 0 0 2px #6366f1, 0 8px 24px rgba(99,102,241,0.15); }

    /* Tab styles */
    .ds-tab {
      position: relative;
      padding: 10px 28px;
      border-radius: 10px 10px 0 0;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      border-bottom: none;
      background: #f3f4f6;
      color: #6b7280;
    }
    .ds-tab.active-tab {
      background: white;
      color: #4f46e5;
      border-color: #e5e7eb;
      border-bottom-color: white;
      z-index: 2;
    }
    .ds-tab:hover:not(.active-tab) { background: #e9eaff; color: #4f46e5; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .tab-bar {
      display: flex;
      gap: 4px;
      border-bottom: 2px solid #e5e7eb;
      position: relative;
      z-index: 1;
      margin-bottom: 0;
    }

    .toggle-switch { position: relative; width: 44px; height: 24px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; inset: 0;
      background: #e5e7eb; border-radius: 24px;
      cursor: pointer; transition: background 0.25s;
    }
    .slider::before {
      content: '';
      position: absolute;
      width: 18px; height: 18px;
      left: 3px; top: 3px;
      background: white; border-radius: 50%;
      transition: transform 0.25s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle-switch input:checked + .slider { background: #6366f1; }
    .toggle-switch input:checked + .slider::before { transform: translateX(20px); }

    .sparkline { overflow: visible; }
    .toast {
      position: fixed; bottom: 24px; right: 24px;
      padding: 14px 20px; border-radius: 12px;
      font-size: 13px; font-weight: 600;
      display: flex; align-items: center; gap: 10px;
      transform: translateY(80px); opacity: 0;
      transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 999; max-width: 340px; pointer-events: none;
    }
    .toast.show { transform: translateY(0); opacity: 1; pointer-events: auto; }
    .loading-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.3); z-index: 200;
      align-items: center; justify-content: center;
      backdrop-filter: blur(3px);
    }
    .loading-overlay.show { display: flex; }
    .spinner {
      width: 40px; height: 40px;
      border: 3px solid #e5e7eb;
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .preview-btn-active {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white; font-weight: 600;
    }
    .preview-btn-empty {
      border: 2px dashed #d1d5db;
      color: #9ca3af;
    }
  </style>
</head>
<body class="bg-gray-100">

  <!-- Sidebar -->
  <aside class="fixed left-0 top-0 h-screen w-64 bg-gradient-to-b from-[#0f1b3f] to-[#2a1b63] text-white shadow-xl z-50">
    <div class="p-6 border-b border-indigo-700">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
          <i class="fas fa-cube text-indigo-700 text-xl"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold">StructuReality</h1>
          <p class="text-xs text-indigo-300">Admin Portal</p>
        </div>
      </div>
    </div>
    <nav class="mt-6 px-4">
      <a href="index.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-indigo-200 hover:bg-indigo-700 mb-2">
        <i class="fas fa-home w-5"></i><span class="font-medium">Dashboard</span>
      </a>
      <a href="users.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-indigo-200 hover:bg-indigo-700 mb-2">
        <i class="fas fa-users w-5"></i><span class="font-medium">Users</span>
      </a>
      <a href="lessons.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-indigo-200 hover:bg-indigo-700 mb-2">
        <i class="fas fa-book w-5"></i><span class="font-medium">Lessons</span>
      </a>
      <a href="quizzes.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-indigo-200 hover:bg-indigo-700 mb-2">
        <i class="fas fa-question-circle w-5"></i><span class="font-medium">Quizzes</span>
      </a>
      <a href="analytics.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-indigo-200 hover:bg-indigo-700 mb-2">
        <i class="fas fa-chart-line w-5"></i><span class="font-medium">Analytics</span>
      </a>
      <a href="scenarios.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-indigo-700 text-white mb-2">
        <i class="fas fa-vr-cardboard w-5"></i><span class="font-medium">AR Scenarios</span>
      </a>
      <a href="instructors.html" id="instructorsLink" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-indigo-200 hover:bg-indigo-700 mb-2">
        <i class="fas fa-chalkboard-teacher w-5"></i><span class="font-medium">Instructors</span>
      </a>
    </nav>
  </aside>

  <!-- Navbar -->
  <nav class="fixed top-0 left-64 right-0 bg-white shadow-md z-40">
    <div class="px-8 py-4 flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold text-gray-800">AR Scenarios</h2>
        <p class="text-sm text-gray-500">Configure which scenarios appear in the AR app per data structure</p>
      </div>
      <div class="flex items-center space-x-4">
        <div class="flex items-center gap-2 px-3 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm">
          <span class="text-gray-500">API:</span>
          <span id="apiStatus" class="font-medium text-yellow-500">connectingâ€¦</span>
        </div>
        <button class="p-2 hover:bg-gray-100 rounded-lg transition">
          <i class="fas fa-bell text-gray-600"></i>
        </button>
        <div class="flex items-center space-x-3 px-4 py-2 hover:bg-gray-100 rounded-lg transition cursor-pointer">
          <div class="w-8 h-8 bg-indigo-200 rounded-full flex items-center justify-center">
            <i class="fas fa-user text-indigo-700 text-sm"></i>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-800" id="adminUserDisplay">Admin User</p>
            <p class="text-xs text-gray-500" id="adminEmailDisplay">admin@admin.com</p>
          </div>
        </div>
        <button onclick="logout()" class="p-2 hover:bg-gray-100 rounded-lg transition" title="Logout">
          <i class="fas fa-sign-out-alt text-gray-600"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="ml-64 mt-20 p-8">

    <!-- DS Tab Bar -->
    <div class="tab-bar mb-0">
      <button class="ds-tab active-tab" id="tab-Arrays" onclick="switchTab('Arrays')">
        <i class="fas fa-list-ol mr-2 text-sm"></i>Arrays
      </button>
      <button class="ds-tab" id="tab-Stacks" onclick="switchTab('Stacks')">
        <i class="fas fa-layer-group mr-2 text-sm"></i>Stacks
      </button>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• ARRAYS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel active bg-white rounded-b-xl rounded-tr-xl shadow-sm border border-t-0 border-gray-200 p-6 mb-6" id="panel-Arrays">

      <!-- App Preview -->
      <div class="bg-gray-50 rounded-xl border border-gray-100 p-4 mb-5 flex items-center gap-5 flex-wrap">
        <div class="flex items-center gap-2 text-sm text-gray-500">
          <i class="fas fa-mobile-alt text-indigo-500"></i>
          <span class="font-medium text-gray-700">Arrays Screen Preview</span>
        </div>
        <i class="fas fa-arrow-right text-gray-300 text-xs"></i>
        <div class="flex gap-3 flex-wrap">
          <div id="arrPreviewBtn1" class="preview-btn-empty px-5 py-2.5 rounded-lg text-sm transition">Button 1</div>
          <div id="arrPreviewBtn2" class="preview-btn-empty px-5 py-2.5 rounded-lg text-sm transition">Button 2</div>
        </div>
        <div class="ml-auto flex items-center gap-2 text-sm">
          <span id="arrActiveCountBadge" class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold text-xs">0 of 3 active</span>
          <span id="arrStatusHint" class="text-gray-400 text-xs">Select 2 scenarios to enable push.</span>
        </div>
      </div>

      <!-- Array Scenario Cards -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-5 mb-6" id="arrScenariosGrid"></div>

      <!-- Push Section -->
      <div class="flex items-center justify-between flex-wrap gap-4 pt-4 border-t border-gray-100">
        <div>
          <h3 class="text-base font-semibold text-gray-800 mb-0.5">Push Arrays Config to App</h3>
          <p class="text-xs text-gray-400">The AR app reads this on every Arrays launch and reset.</p>
        </div>
        <div class="flex gap-3">
          <button onclick="loadConfig('Arrays')"
            class="flex items-center gap-2 px-4 py-2 border border-gray-200 rounded-lg text-sm font-semibold text-gray-700 hover:border-indigo-400 hover:text-indigo-600 transition">
            <i class="fas fa-sync-alt"></i> Reload
          </button>
          <button id="arrPushBtn" onclick="pushConfig('Arrays')" disabled
            class="flex items-center gap-2 px-5 py-2 rounded-lg text-sm font-semibold text-white bg-gradient-to-r from-indigo-500 to-purple-600 hover:opacity-90 transition disabled:opacity-40 disabled:cursor-not-allowed">
            <i class="fas fa-upload"></i> Push Arrays
          </button>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• STACKS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel bg-white rounded-b-xl rounded-tr-xl shadow-sm border border-t-0 border-gray-200 p-6 mb-6" id="panel-Stacks">

      <!-- App Preview -->
      <div class="bg-gray-50 rounded-xl border border-gray-100 p-4 mb-5 flex items-center gap-5 flex-wrap">
        <div class="flex items-center gap-2 text-sm text-gray-500">
          <i class="fas fa-mobile-alt text-purple-500"></i>
          <span class="font-medium text-gray-700">Stacks Screen Preview</span>
        </div>
        <i class="fas fa-arrow-right text-gray-300 text-xs"></i>
        <div class="flex gap-3 flex-wrap">
          <div id="stkPreviewBtn1" class="preview-btn-empty px-5 py-2.5 rounded-lg text-sm transition">Button 1</div>
          <div id="stkPreviewBtn2" class="preview-btn-empty px-5 py-2.5 rounded-lg text-sm transition">Button 2</div>
        </div>
        <div class="ml-auto flex items-center gap-2 text-sm">
          <span id="stkActiveCountBadge" class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold text-xs">0 of 3 active</span>
          <span id="stkStatusHint" class="text-gray-400 text-xs">Select 2 scenarios to enable push.</span>
        </div>
      </div>

      <!-- Stack Scenario Cards -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-5 mb-6" id="stkScenariosGrid"></div>

      <!-- Push Section -->
      <div class="flex items-center justify-between flex-wrap gap-4 pt-4 border-t border-gray-100">
        <div>
          <h3 class="text-base font-semibold text-gray-800 mb-0.5">Push Stacks Config to App</h3>
          <p class="text-xs text-gray-400">The AR app reads this on every Stacks launch and reset.</p>
        </div>
        <div class="flex gap-3">
          <button onclick="loadConfig('Stacks')"
            class="flex items-center gap-2 px-4 py-2 border border-gray-200 rounded-lg text-sm font-semibold text-gray-700 hover:border-indigo-400 hover:text-indigo-600 transition">
            <i class="fas fa-sync-alt"></i> Reload
          </button>
          <button id="stkPushBtn" onclick="pushConfig('Stacks')" disabled
            class="flex items-center gap-2 px-5 py-2 rounded-lg text-sm font-semibold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:opacity-90 transition disabled:opacity-40 disabled:cursor-not-allowed">
            <i class="fas fa-upload"></i> Push Stacks
          </button>
        </div>
      </div>
    </div>

    <!-- Activity Log -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 mt-2">
      <div class="p-5 border-b border-gray-100 flex items-center justify-between">
        <h3 class="text-base font-semibold text-gray-800">Activity Log</h3>
        <button onclick="clearLog()" class="text-xs text-gray-400 hover:text-gray-600 transition">Clear</button>
      </div>
      <div class="p-5 space-y-2.5 max-h-52 overflow-y-auto" id="logList">
        <div class="flex items-center gap-3 text-sm text-gray-600">
          <div class="w-2 h-2 rounded-full bg-indigo-400 flex-shrink-0"></div>
          <span>Admin panel loaded â€” fetching server configâ€¦</span>
          <span class="ml-auto text-xs text-gray-400" id="initTime"></span>
        </div>
      </div>
    </div>
  </main>

  <div class="toast" id="toast"></div>
  <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>

  <script>
    // â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SERVER_URL = 'https://structureality-admin.onrender.com';
    const MAX_ACTIVE = 2;

    // â”€â”€ SCENARIO DEFINITIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SCENARIOS = {
      Arrays: [
        {
          id: 'ParkingLot', name: 'Parking Lot', icon: 'ðŸ…¿ï¸',
          desc: 'Cars in numbered parking spots. Students INSERT cars, REMOVE them, and ACCESS a spot by index.',
          ops: ['INSERT', 'REMOVE', 'ACCESS', 'SORTED INSERT', 'BINARY SEARCH'],
          sessions: [120, 145, 130, 160, 175, 155, 180], avgTime: '4.2 min',
        },
        {
          id: 'VendingMachine', name: 'Vending Machine', icon: 'ðŸª',
          desc: '2Ã—3 grid of product slots. Students RESTOCK items, DISPENSE them, and INSPECT a slot by grid address.',
          ops: ['RESTOCK', 'DISPENSE', 'INSPECT', 'SORTED RESTOCK', 'PRICE SEARCH'],
          sessions: [95, 110, 130, 145, 160, 140, 170], avgTime: '3.8 min',
        },
        {
          id: 'Supermarket', name: 'Supermarket Shelf', icon: 'ðŸ›’',
          desc: 'Linear shelf with 6 grocery slots. Students STOCK items, PULL them off, and CHECK by index.',
          ops: ['STOCK', 'PULL', 'CHECK', 'SORTED STOCK', 'BARCODE SCAN'],
          sessions: [90, 110, 140, 175, 160, 155, 200], avgTime: '4.0 min',
        },
      ],
      Stacks: [
        {
          id: 'Plates', name: 'Plates', icon: 'ðŸ½ï¸',
          desc: 'Classic dinner plate stack on a round table. Students PUSH plates onto the stack and POP them off â€” pure LIFO.',
          ops: ['PUSH', 'POP', 'PEEK', 'MULTI-POP', 'REVERSE'],
          sessions: [110, 125, 138, 152, 167, 145, 180], avgTime: '3.9 min',
        },
        {
          id: 'Warehouse', name: 'Warehouse', icon: 'ðŸ“¦',
          desc: 'Cardboard boxes stacked on a forklift pallet. PUSH boxes on, POP them off â€” LIFO in a storage context.',
          ops: ['PUSH', 'POP', 'PEEK', 'MULTI-POP', 'REVERSE'],
          sessions: [100, 118, 135, 148, 162, 140, 175], avgTime: '4.1 min',
        },
        {
          id: 'Kitchen', name: 'Kitchen', icon: 'ðŸ³',
          desc: 'Pots and pans stacked on a stove burner. PUSH cookware onto the stack, POP them off to cook â€” intuitive LIFO.',
          ops: ['PUSH', 'POP', 'PEEK', 'MULTI-POP', 'REVERSE'],
          sessions: [85, 105, 128, 155, 168, 150, 195], avgTime: '4.0 min',
        },
      ],
    };

    // â”€â”€ STATE â€” per DS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const state = {
      Arrays: { activeIds: [] },
      Stacks: { activeIds: [] },
    };

    let currentTab = 'Arrays';

    // â”€â”€ TAB SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function switchTab(ds) {
      currentTab = ds;
      document.querySelectorAll('.ds-tab').forEach(t => t.classList.remove('active-tab'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(`tab-${ds}`).classList.add('active-tab');
      document.getElementById(`panel-${ds}`).classList.add('active');
    }

    // â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function logout() {
      localStorage.removeItem('adminUser');
      window.location.href = 'login.html';
    }

    function checkAuth() {
      const raw = localStorage.getItem('adminUser');
      if (!raw || raw === 'undefined') { logout(); return null; }
      try { return JSON.parse(raw); } catch { logout(); return null; }
    }

    // â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showToast(msg, type = 'info') {
      const colorMap = {
        success: 'bg-green-50 border border-green-300 text-green-700',
        error:   'bg-red-50 border border-red-300 text-red-700',
        info:    'bg-indigo-50 border border-indigo-300 text-indigo-700',
      };
      const iconMap = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' };
      const t = document.getElementById('toast');
      t.className = `toast ${colorMap[type]}`;
      t.innerHTML = `<i class="fas ${iconMap[type]}"></i> ${msg}`;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3500);
    }

    function showLoading(v) {
      document.getElementById('loadingOverlay').classList.toggle('show', v);
    }

    // â”€â”€ LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function addLog(msg, type = 'info') {
      const list = document.getElementById('logList');
      const now  = new Date().toLocaleTimeString();
      const dotColor = type === 'success' ? 'bg-green-400' : type === 'error' ? 'bg-red-400' : 'bg-indigo-400';
      const el = document.createElement('div');
      el.className = 'flex items-center gap-3 text-sm text-gray-600';
      el.innerHTML = `<div class="w-2 h-2 rounded-full ${dotColor} flex-shrink-0"></div><span>${msg}</span><span class="ml-auto text-xs text-gray-400">${now}</span>`;
      list.prepend(el);
      while (list.children.length > 30) list.removeChild(list.lastChild);
    }

    function clearLog() {
      document.getElementById('logList').innerHTML = '';
    }

    // â”€â”€ RENDER CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderGrid(ds) {
      const prefix    = ds === 'Arrays' ? 'arr' : 'stk';
      const grid      = document.getElementById(`${prefix}ScenariosGrid`);
      const activeIds = state[ds].activeIds;
      grid.innerHTML  = '';

      SCENARIOS[ds].forEach(sc => {
        const isActive   = activeIds.includes(sc.id);
        const pos        = activeIds.indexOf(sc.id) + 1;
        const maxReached = activeIds.length >= MAX_ACTIVE && !isActive;
        const total      = sc.sessions.reduce((a, b) => a + b, 0);
        const sparkId    = `spark_${ds}_${sc.id}`;

        const card = document.createElement('div');
        card.className = `scenario-card bg-white rounded-xl shadow-sm border-2 ${isActive ? 'border-indigo-500 active' : 'border-gray-100'} p-5 cursor-pointer card-hover`;
        card.onclick = () => toggleScenario(ds, sc.id);

        card.innerHTML = `
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-center gap-3">
              <div class="w-11 h-11 ${isActive ? 'bg-indigo-100' : 'bg-gray-100'} rounded-xl flex items-center justify-center text-2xl">
                ${sc.icon}
              </div>
              <div>
                <h3 class="font-semibold text-gray-800 text-sm">${sc.name}</h3>
                <span class="text-xs font-mono text-gray-400 bg-gray-100 px-2 py-0.5 rounded">${sc.id}</span>
              </div>
            </div>
            <div class="flex flex-col items-end gap-1.5">
              ${isActive ? `<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-600">Button ${pos}</span>` : ''}
              <label class="toggle-switch" onclick="event.stopPropagation()">
                <input type="checkbox" ${isActive ? 'checked' : ''} ${maxReached ? 'disabled' : ''} onchange="toggleScenario('${ds}', '${sc.id}')">
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <p class="text-xs text-gray-500 leading-relaxed mb-3">${sc.desc}</p>

          <div class="flex flex-wrap gap-1 mb-3">
            ${sc.ops.map(op => `<span class="text-xs px-2 py-0.5 rounded-full ${isActive ? 'bg-indigo-50 text-indigo-600 border border-indigo-200' : 'bg-gray-100 text-gray-500'} font-mono">${op}</span>`).join('')}
          </div>

          <div class="border-t border-gray-100 pt-3 flex items-center justify-between">
            <div class="text-center">
              <p class="text-lg font-bold text-gray-800">${total}</p>
              <p class="text-xs text-gray-400">Sessions</p>
            </div>
            <svg class="sparkline flex-1 mx-3" id="${sparkId}" height="28" viewBox="0 0 100 28" preserveAspectRatio="none"></svg>
            <div class="text-center">
              <p class="text-lg font-bold text-gray-800">${sc.avgTime}</p>
              <p class="text-xs text-gray-400">Avg Time</p>
            </div>
          </div>
        `;

        grid.appendChild(card);
        drawSparkline(sparkId, sc.sessions, isActive);
      });

      updateStatusBar(ds);
      updatePreview(ds);
    }

    function drawSparkline(id, data, active) {
      const svg = document.getElementById(id);
      if (!svg) return;
      const w = 100, h = 28;
      const min = Math.min(...data), max = Math.max(...data);
      const range = max - min || 1;
      const pts = data.map((v, i) => {
        const x = (i / (data.length - 1)) * w;
        const y = h - ((v - min) / range) * (h - 5) - 2.5;
        return `${x},${y}`;
      });
      const color = active ? '#6366f1' : '#d1d5db';
      svg.innerHTML = `<polyline points="${pts.join(' ')}" fill="none" stroke="${color}" stroke-width="2"
        stroke-linejoin="round" stroke-linecap="round"/>`;
    }

    function updateStatusBar(ds) {
      const prefix    = ds === 'Arrays' ? 'arr' : 'stk';
      const n         = state[ds].activeIds.length;
      const badge     = document.getElementById(`${prefix}ActiveCountBadge`);
      const hint      = document.getElementById(`${prefix}StatusHint`);
      const btn       = document.getElementById(`${prefix}PushBtn`);
      const total     = SCENARIOS[ds].length;

      badge.textContent = `${n} of ${total} active`;
      badge.className   = `px-3 py-1 rounded-full font-semibold text-xs ${n === MAX_ACTIVE ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`;

      if (n === MAX_ACTIVE) {
        hint.textContent = 'âœ“ Exactly 2 selected â€” ready to push.';
        hint.className   = 'text-green-600 text-xs font-medium';
        btn.disabled     = false;
      } else {
        const need = MAX_ACTIVE - n;
        hint.textContent = `Select ${need} more scenario${need !== 1 ? 's' : ''} to enable push.`;
        hint.className   = 'text-gray-400 text-xs';
        btn.disabled     = true;
      }
    }

    function updatePreview(ds) {
      const prefix    = ds === 'Arrays' ? 'arr' : 'stk';
      const activeIds = state[ds].activeIds;
      const b1        = document.getElementById(`${prefix}PreviewBtn1`);
      const b2        = document.getElementById(`${prefix}PreviewBtn2`);
      const s1        = SCENARIOS[ds].find(s => s.id === activeIds[0]);
      const s2        = SCENARIOS[ds].find(s => s.id === activeIds[1]);

      if (s1) { b1.textContent = `${s1.icon} ${s1.name}`; b1.className = 'preview-btn-active px-5 py-2.5 rounded-lg text-sm transition'; }
      else    { b1.textContent = 'Button 1'; b1.className = 'preview-btn-empty px-5 py-2.5 rounded-lg text-sm transition'; }

      if (s2) { b2.textContent = `${s2.icon} ${s2.name}`; b2.className = 'preview-btn-active px-5 py-2.5 rounded-lg text-sm transition'; }
      else    { b2.textContent = 'Button 2'; b2.className = 'preview-btn-empty px-5 py-2.5 rounded-lg text-sm transition'; }
    }

    // â”€â”€ TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleScenario(ds, id) {
      const activeIds = state[ds].activeIds;
      const idx       = activeIds.indexOf(id);
      if (idx >= 0) {
        activeIds.splice(idx, 1);
      } else {
        if (activeIds.length >= MAX_ACTIVE) {
          showToast(`Max ${MAX_ACTIVE} scenarios allowed â€” deactivate one first.`, 'error');
          renderGrid(ds);
          return;
        }
        activeIds.push(id);
      }
      renderGrid(ds);
    }

    // â”€â”€ LOAD FROM SERVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadConfig(ds) {
      showLoading(true);
      try {
        const res  = await fetch(`${SERVER_URL}/api/scenarios/config`);
        const data = await res.json();

        if (data.success && data.config?.scenarios) {
          // Load for the specified DS
          const ids = data.config.scenarios[ds] || [];
          state[ds].activeIds = ids.filter(id => SCENARIOS[ds].some(s => s.id === id));
        } else {
          // Fallback defaults
          state[ds].activeIds = ds === 'Arrays'
            ? ['ParkingLot', 'VendingMachine']
            : ['Plates', 'Warehouse'];
        }

        document.getElementById('apiStatus').textContent = 'connected';
        document.getElementById('apiStatus').className   = 'font-medium text-green-500';
        addLog(`[${ds}] Loaded â€” active: [${state[ds].activeIds.join(', ')}]`, 'success');
        showToast(`${ds} config loaded.`, 'success');
      } catch (err) {
        // Fallback if server unreachable
        if (!state[ds].activeIds.length) {
          state[ds].activeIds = ds === 'Arrays'
            ? ['ParkingLot', 'VendingMachine']
            : ['Plates', 'Warehouse'];
        }
        document.getElementById('apiStatus').textContent = 'offline';
        document.getElementById('apiStatus').className   = 'font-medium text-red-500';
        addLog(`[${ds}] Server unreachable â€” using local state.`, 'error');
        showToast('Server unreachable. Working offline.', 'error');
      } finally {
        showLoading(false);
        renderGrid(ds);
      }
    }

    // â”€â”€ PUSH TO SERVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function pushConfig(ds) {
      const activeIds = state[ds].activeIds;
      if (activeIds.length !== MAX_ACTIVE) {
        showToast(`Select exactly ${MAX_ACTIVE} scenarios first.`, 'error');
        return;
      }
      showLoading(true);
      try {
        // Merge both DS configs into a single payload so we don't overwrite the other
        const payload = {
          scenarios: {
            Arrays: [...state.Arrays.activeIds],
            Stacks: [...state.Stacks.activeIds],
          }
        };
        const res  = await fetch(`${SERVER_URL}/api/scenarios/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (data.success) {
          const labels = activeIds.map(id => {
            const s = SCENARIOS[ds].find(x => x.id === id);
            return s ? `${s.icon} ${s.name}` : id;
          }).join(' + ');
          addLog(`[${ds}] Pushed â€” [${activeIds.join(', ')}] â†’ live in app.`, 'success');
          showToast(`${ds} pushed! App shows: ${labels}`, 'success');
        } else {
          throw new Error(data.message || 'Server returned failure');
        }
      } catch (err) {
        addLog(`[${ds}] Push failed: ${err.message}`, 'error');
        showToast(`Push failed: ${err.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.addEventListener('load', async () => {
      const user = checkAuth();
      if (user) {
        document.getElementById('adminUserDisplay').textContent  = user.name || user.username;
        document.getElementById('adminEmailDisplay').textContent = user.email || '';
        if (user.role === 'instructor') {
          const link = document.getElementById('instructorsLink');
          if (link) link.style.display = 'none';
        }
      }
      document.getElementById('initTime').textContent = new Date().toLocaleTimeString();

      // Load both DS configs in parallel
      showLoading(true);
      try {
        const res  = await fetch(`${SERVER_URL}/api/scenarios/config`);
        const data = await res.json();
        if (data.success && data.config?.scenarios) {
          ['Arrays', 'Stacks'].forEach(ds => {
            const ids = data.config.scenarios[ds] || [];
            state[ds].activeIds = ids.filter(id => SCENARIOS[ds].some(s => s.id === id));
          });
        } else {
          state.Arrays.activeIds = ['ParkingLot', 'VendingMachine'];
          state.Stacks.activeIds = ['Plates', 'Warehouse'];
        }
        document.getElementById('apiStatus').textContent = 'connected';
        document.getElementById('apiStatus').className   = 'font-medium text-green-500';
        addLog('Both configs loaded from server.', 'success');
      } catch {
        state.Arrays.activeIds = ['ParkingLot', 'VendingMachine'];
        state.Stacks.activeIds = ['Plates', 'Warehouse'];
        document.getElementById('apiStatus').textContent = 'offline';
        document.getElementById('apiStatus').className   = 'font-medium text-red-500';
        addLog('Server unreachable â€” defaults applied.', 'error');
      } finally {
        showLoading(false);
        renderGrid('Arrays');
        renderGrid('Stacks');
      }
    });
  </script>
</body>
</html>